{"version":3,"sources":["../src/learningnote.js"],"names":["define","$","ModalFactory","String","Fragment","ModalEvents","Ajax","notification","learningToolNoteAction","contextid","params","showModalLttool","sorttypefilter","document","querySelector","addEventListener","sorttype","getAttribute","noteSortActionPage","removeURLParameter","url","parameter","urlparts","split","length","prefix","encodeURIComponent","pars","i","lastIndexOf","splice","join","notesinfo","newnote","get_string","when","done","localizedEditString","ltoolnotebody","getElementsByTagName","classList","contains","add","create","title","getPopoutAction","type","types","SAVE_CANCEL","body","getnoteaction","large","then","modal","show","getRoot","on","hidden","destroy","save","e","preventDefault","submitFormData","submit","pageurlobj","pageurl","pageurljson","JSON","stringify","M","cfg","wwwroot","pagetype","contextlevel","course","user","pagetitle","heading","hide","window","open","catch","exception","location","href","para","indexOf","modalform","querySelectorAll","formData","URLSearchParams","FormData","toString","notesuccess","call","methodname","args","formdata","response","noteinfo","innerHTML","addNotification","message","ltools","disappertimenotify","setTimeout","loadFragment","init"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Notes ltool define js.\n * @package   ltool_note\n * @category  Classes - autoloading\n * @copyright 2021, bdecent gmbh bdecent.de\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/modal_factory', 'core/str', 'core/fragment', 'core/modal_events', 'core/ajax', 'core/notification'],\n    function($, ModalFactory, String, Fragment, ModalEvents, Ajax, notification) {\n\n    /* global ltools */\n\n    /**\n     * Controls notes tool action.\n     * @param {int} contextid context id\n     * @param {object} params notes info params\n     */\n    function learningToolNoteAction(contextid, params) {\n        showModalLttool(contextid, params);\n        var sorttypefilter = document.querySelector(\".ltnote-sortfilter i#notessorttype\");\n        if (sorttypefilter) {\n            sorttypefilter.addEventListener(\"click\", function() {\n                var sorttype = this.getAttribute('data-type');\n                noteSortActionPage(sorttype);\n            });\n        }\n    }\n\n    /**\n     * Clean the url parameters.\n     * @param {string} url page url.\n     * @param {string} parameter url parameter.\n     * @return {url} sort url\n     */\n    function removeURLParameter(url, parameter) {\n        // Prefer to use l.search if you have a location/link object.\n        var urlparts = url.split('?');\n        if (urlparts.length >= 2) {\n\n            var prefix = encodeURIComponent(parameter) + '=';\n            var pars = urlparts[1].split(/[&;]/g);\n\n            // Reverse iteration as may be destructive.\n            for (var i = pars.length; i-- > 0;) {\n                // Idiom for string.startsWith.\n                if (pars[i].lastIndexOf(prefix, 0) !== -1) {\n                    pars.splice(i, 1);\n                }\n            }\n\n            url = urlparts[0] + (pars.length > 0 ? '?' + pars.join('&') : \"\");\n            return url;\n        } else {\n            return url;\n        }\n    }\n\n    /**\n     * Display the modal popup.\n     * @param {int} contextid context id\n     * @param {object} params notes info params\n     * @return {void}\n     */\n    function showModalLttool(contextid, params) {\n\n        var notesinfo = document.querySelector(\".ltnoteinfo #ltnote-action\");\n        if (notesinfo) {\n            notesinfo.addEventListener(\"click\", function() {\n                var newnote = String.get_string('newnote', 'local_learningtools');\n\n                $.when(newnote).done(function(localizedEditString) {\n                    // Add class.\n                    var ltoolnotebody = document.getElementsByTagName('body')[0];\n                    if (!ltoolnotebody.classList.contains('learningtool-note')) {\n                        ltoolnotebody.classList.add('learningtool-note');\n                    }\n\n                    ModalFactory.create({\n                        title: localizedEditString + getPopoutAction(),\n                        type: ModalFactory.types.SAVE_CANCEL,\n                        body: getnoteaction(contextid, params),\n                        large: true\n                    }).then(function(modal) {\n\n                        modal.show();\n\n                        modal.getRoot().on(ModalEvents.hidden, function() {\n                            modal.destroy();\n                        });\n\n                        modal.getRoot().on(ModalEvents.save, function(e) {\n\n                            e.preventDefault();\n                            submitFormData(modal, contextid, params);\n                            modal.getRoot().submit();\n                        });\n\n                        document.querySelector(\"#popout-action\").addEventListener('click', function() {\n                            var pageurlobj = params.pageurl.split(\"&\");\n                            var pageurljson = JSON.stringify(pageurlobj);\n                            var url = M.cfg.wwwroot + \"/local/learningtools/ltool/note/pop_out.php?contextid=\" +\n                            params.contextid + \"&pagetype=\" + params.pagetype + \"&contextlevel=\" + params.contextlevel + \"&course=\"\n                            + params.course + \"&user=\" + params.user + \"&pageurl=\" + pageurljson + \"&pagetitle=\" + params.pagetitle\n                            + \"&heading=\" + params.heading;\n                            modal.hide();\n                            window.open(url, '_blank');\n                        });\n                        return modal;\n                    }).catch(notification.exception);\n                });\n\n            });\n        }\n    }\n\n    /**\n     * Sort the notes list.\n     * @param {string} sorttype sort type\n     * @return {void}\n     */\n    function noteSortActionPage(sorttype) {\n\n        var pageurl = window.location.href;\n        pageurl = removeURLParameter(pageurl, 'sorttype');\n\n        if (sorttype == 'asc') {\n            sorttype = 'desc';\n        } else if (sorttype == 'desc') {\n            sorttype = 'asc';\n        }\n        var para = '';\n        if (pageurl.indexOf('?') > -1) {\n            para = '&';\n        } else {\n            para = '?';\n        }\n\n        pageurl = pageurl + para + 'sorttype=' + sorttype;\n        window.open(pageurl, '_self');\n    }\n\n    /**\n     * Popout url action html.\n     * @return {string} popout html\n     */\n    function getPopoutAction() {\n        var popouthtml = \"<div class='popout-block'><button type='submit' id='popout-action'\"\n        + \"name='popoutsubmit'>Pop out</button> <i class='fa fa-window-restore'></i></div>\";\n        return popouthtml;\n    }\n\n    /**\n     * Submit the modal data form.\n     * @param {object} modal object\n     * @param {int} contextid context id\n     * @return {void} ajax respoltoolsnse.\n     */\n    function submitFormData(modal, contextid) {\n\n        var modalform = document.querySelectorAll('.ltoolusernotes form')[0];\n        var formData = new URLSearchParams(new FormData(modalform)).toString();\n        var notesuccess = String.get_string('successnotemessage', 'local_learningtools');\n        Ajax.call([{\n            methodname: 'ltool_note_save_usernote',\n            args: {contextid: contextid, formdata: formData},\n            done: function(response) {\n                // Insert data into notes badge.\n                if (response) {\n                    var noteinfo = document.querySelector(\".ltnoteinfo span\");\n                    if (!noteinfo.classList.contains('ticked')) {\n                        noteinfo.classList.add('ticked');\n                    }\n                    noteinfo.innerHTML = response;\n                }\n\n                modal.hide();\n                $.when(notesuccess).done(function(localizedEditString) {\n                    notification.addNotification({\n                        message: localizedEditString,\n                        type: \"success\"\n                    });\n                });\n\n                if (ltools.disappertimenotify != 0) {\n                    setTimeout(function() {\n                        document.querySelector(\"span.notifications\").innerHTML = \"\";\n                    }, ltools.disappertimenotify);\n                }\n            },\n        }]);\n    }\n\n    /**\n     * Submit the modal data form.\n     * @param {int} contextid\n     * @param {object} params list of the notes params.\n     * @return {string} displayed the note editor form\n     */\n    function getnoteaction(contextid, params) {\n        params.contextid = contextid;\n        if (params.pagetitle == \"\") {\n            params.pagetitle = document.querySelector(\"title\").innerHTML;\n        }\n        return Fragment.loadFragment('ltool_note', 'get_note_form', contextid, params);\n    }\n    return {\n        init: function(contextid, params) {\n            learningToolNoteAction(contextid, params);\n        }\n    };\n});"],"file":"learningnote.min.js"}