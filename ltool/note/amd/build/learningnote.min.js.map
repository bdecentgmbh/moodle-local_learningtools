{"version":3,"file":"learningnote.min.js","sources":["../src/learningnote.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Notes ltool define js.\n * @module   ltool_note\n * @category  Classes - autoloading\n * @copyright 2021, bdecent gmbh bdecent.de\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/modal_factory', 'core/str', 'core/fragment', 'core/modal_events', 'core/ajax', 'core/notification'],\n    function($, ModalFactory, String, Fragment, ModalEvents, Ajax, notification) {\n\n    /* global ltools */\n\n    /**\n     * Controls notes tool action.\n     * @param {int} contextid context id\n     * @param {object} params notes info params\n     */\n    function learningToolNoteAction(contextid, params) {\n        showModalLttool(contextid, params);\n        var sorttypefilter = document.querySelector(\".ltnote-sortfilter i#notessorttype\");\n        if (sorttypefilter) {\n            sorttypefilter.addEventListener(\"click\", function() {\n                var sorttype = this.getAttribute('data-type');\n                noteSortActionPage(sorttype);\n            });\n        }\n    }\n\n    /**\n     * Clean the url parameters.\n     * @param {string} url page url.\n     * @param {string} parameter url parameter.\n     * @return {url} sort url\n     */\n    function removeURLParameter(url, parameter) {\n        // Prefer to use l.search if you have a location/link object.\n        var urlparts = url.split('?');\n        if (urlparts.length >= 2) {\n\n            var prefix = encodeURIComponent(parameter) + '=';\n            var pars = urlparts[1].split(/[&;]/g);\n\n            // Reverse iteration as may be destructive.\n            for (var i = pars.length; i-- > 0;) {\n                // Idiom for string.startsWith.\n                if (pars[i].lastIndexOf(prefix, 0) !== -1) {\n                    pars.splice(i, 1);\n                }\n            }\n\n            url = urlparts[0] + (pars.length > 0 ? '?' + pars.join('&') : \"\");\n            return url;\n        } else {\n            return url;\n        }\n    }\n\n    /**\n     * Display the modal popup.\n     * @param {int} contextid context id\n     * @param {object} params notes info params\n     * @return {void}\n     */\n    function showModalLttool(contextid, params) {\n\n        var notesinfo = document.querySelector(\".ltnoteinfo #ltnote-action\");\n        if (notesinfo) {\n            notesinfo.addEventListener(\"click\", function() {\n                var newnote = String.get_string('newnote', 'local_learningtools');\n\n                $.when(newnote).done(function(localizedEditString) {\n                    // Add class.\n                    var ltoolnotebody = document.getElementsByTagName('body')[0];\n                    if (!ltoolnotebody.classList.contains('learningtool-note')) {\n                        ltoolnotebody.classList.add('learningtool-note');\n                    }\n\n                    ModalFactory.create({\n                        title: localizedEditString + getPopoutAction(),\n                        type: ModalFactory.types.SAVE_CANCEL,\n                        body: getnoteaction(contextid, params),\n                        large: true\n                    }).then(function(modal) {\n\n                        modal.show();\n\n                        modal.getRoot().on(ModalEvents.hidden, function() {\n                            modal.destroy();\n                        });\n\n                        modal.getRoot().on(ModalEvents.save, function(e) {\n                            e.preventDefault();\n                            $(e.target).find(\"button[data-action=save]\").attr(\"disabled\", true);\n                            modal.getRoot().find('form').submit();\n                        });\n\n                        modal.getRoot().on('submit', 'form', e => {\n                            e.preventDefault();\n                            submitFormData(modal, contextid);\n                        });\n\n                        document.querySelector(\"#popout-action\").addEventListener('click', function() {\n                            var pageurlobj = params.pageurl.split(\"&\");\n                            var pageurljson = JSON.stringify(pageurlobj);\n                            var url = M.cfg.wwwroot + \"/local/learningtools/ltool/note/pop_out.php?contextid=\" +\n                            params.contextid + \"&pagetype=\" + params.pagetype + \"&contextlevel=\" + params.contextlevel + \"&course=\"\n                            + params.course + \"&user=\" + params.user + \"&pageurl=\" + pageurljson + \"&pagetitle=\" + params.pagetitle\n                            + \"&heading=\" + params.heading + \"&sesskey=\" + params.sesskey;\n                            modal.hide();\n                            window.open(url, '_blank');\n                        });\n                        return modal;\n                    }).catch(notification.exception);\n                });\n\n            });\n            // Hover color.\n            var notehovercolor = notesinfo.getAttribute(\"data-hovercolor\");\n            var notefontcolor = notesinfo.getAttribute(\"data-fontcolor\");\n            if (notehovercolor && notefontcolor) {\n                notesinfo.addEventListener(\"mouseover\", function() {\n                    document.querySelector('#ltnoteinfo p').style.background = notehovercolor;\n                    document.querySelector('#ltnoteinfo p').style.color = notefontcolor;\n                });\n            }\n        }\n    }\n\n    /**\n     * Sort the notes list.\n     * @param {string} sorttype sort type\n     * @return {void}\n     */\n    function noteSortActionPage(sorttype) {\n\n        var pageurl = window.location.href;\n        pageurl = removeURLParameter(pageurl, 'sorttype');\n\n        if (sorttype == 'asc') {\n            sorttype = 'desc';\n        } else if (sorttype == 'desc') {\n            sorttype = 'asc';\n        }\n        var para = '';\n        if (pageurl.indexOf('?') > -1) {\n            para = '&';\n        } else {\n            para = '?';\n        }\n\n        pageurl = pageurl + para + 'sorttype=' + sorttype;\n        window.open(pageurl, '_self');\n    }\n\n    /**\n     * Popout url action html.\n     * @return {string} popout html\n     */\n    function getPopoutAction() {\n        var popouthtml = \"<div class='popout-block'><button type='submit' id='popout-action'\"\n        + \"name='popoutsubmit'>Pop out</button> <i class='fa fa-window-restore'></i></div>\";\n        return popouthtml;\n    }\n\n    /**\n     * Submit the modal data form.\n     * @param {object} modal object\n     * @param {int} contextid context id\n     * @return {void} ajax respoltoolsnse.\n     */\n    function submitFormData(modal, contextid) {\n\n        var modalform = document.querySelectorAll('.ltoolusernotes form')[0];\n        var formData = new URLSearchParams(new FormData(modalform)).toString();\n        var notesuccess = String.get_string('successnotemessage', 'local_learningtools');\n        Ajax.call([{\n            methodname: 'ltool_note_save_usernote',\n            args: {contextid: contextid, formdata: formData},\n            done: function(response) {\n                // Insert data into notes badge.\n                if (response) {\n                    var noteinfo = document.querySelector(\".ltnoteinfo span\");\n                    if (!noteinfo.classList.contains('ticked')) {\n                        noteinfo.classList.add('ticked');\n                    }\n                    noteinfo.innerHTML = response;\n                }\n\n                modal.hide();\n                $.when(notesuccess).done(function(localizedEditString) {\n                    notification.addNotification({\n                        message: localizedEditString,\n                        type: \"success\"\n                    });\n                });\n\n                if (ltools.disappertimenotify != 0) {\n                    setTimeout(function() {\n                        document.querySelector(\"span.notifications\").innerHTML = \"\";\n                    }, ltools.disappertimenotify);\n                }\n            },\n        }]);\n    }\n\n    /**\n     * Submit the modal data form.\n     * @param {int} contextid\n     * @param {object} params list of the notes params.\n     * @return {string} displayed the note editor form\n     */\n    function getnoteaction(contextid, params) {\n        params.contextid = contextid;\n        if (params.pagetitle == \"\") {\n            params.pagetitle = document.querySelector(\"title\").innerHTML;\n        }\n        return Fragment.loadFragment('ltool_note', 'get_note_form', contextid, params);\n    }\n    return {\n        init: function(contextid, params) {\n            learningToolNoteAction(contextid, params);\n        }\n    };\n});"],"names":["define","$","ModalFactory","String","Fragment","ModalEvents","Ajax","notification","learningToolNoteAction","contextid","params","notesinfo","document","querySelector","addEventListener","newnote","get_string","when","done","localizedEditString","ltoolnotebody","getElementsByTagName","classList","contains","add","create","title","getPopoutAction","type","types","SAVE_CANCEL","body","getnoteaction","large","then","modal","show","getRoot","on","hidden","destroy","save","e","preventDefault","target","find","attr","submit","modalform","querySelectorAll","formData","URLSearchParams","FormData","toString","notesuccess","call","methodname","args","formdata","response","noteinfo","innerHTML","hide","addNotification","message","ltools","disappertimenotify","setTimeout","submitFormData","pageurlobj","pageurl","split","pageurljson","JSON","stringify","url","M","cfg","wwwroot","pagetype","contextlevel","course","user","pagetitle","heading","sesskey","window","open","catch","exception","notehovercolor","getAttribute","notefontcolor","style","background","color","showModalLttool","sorttypefilter","sorttype","location","href","parameter","urlparts","length","prefix","encodeURIComponent","pars","i","lastIndexOf","splice","join","removeURLParameter","para","indexOf","noteSortActionPage","this","loadFragment","init"],"mappings":"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"}