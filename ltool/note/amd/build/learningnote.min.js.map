{"version":3,"file":"learningnote.min.js","sources":["../src/learningnote.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Notes ltool define js.\r\n * @module   ltool_note\r\n * @category  Classes - autoloading\r\n * @copyright 2021, bdecent gmbh bdecent.de\r\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\ndefine(['jquery', 'core/modal_factory', 'core/str', 'core/fragment', 'core/modal_events', 'core/ajax', 'core/notification'],\r\n    function($, ModalFactory, String, Fragment, ModalEvents, Ajax, notification) {\r\n\r\n    /* global ltools */\r\n\r\n    /**\r\n     * Controls notes tool action.\r\n     * @param {int} contextid context id\r\n     * @param {object} params notes info params\r\n     */\r\n    function learningToolNoteAction(contextid, params) {\r\n        showModalLttool(contextid, params);\r\n        var sorttypefilter = document.querySelector(\".ltnote-sortfilter i#notessorttype\");\r\n        if (sorttypefilter) {\r\n            sorttypefilter.addEventListener(\"click\", function() {\r\n                var sorttype = this.getAttribute('data-type');\r\n                noteSortActionPage(sorttype);\r\n            });\r\n        }\r\n        // Content designer note.\r\n        $(document).on('click', '.content-designer-learningtool-note', function(e) {\r\n            var button = $(this);\r\n            var itemType = button.data('itemtype');\r\n            var itemId = button.data('itemid');\r\n            var pageurl = button.data('pageurl');\r\n            params.itemtype = itemType;\r\n            params.itemid = itemId;\r\n            params.pageurl = pageurl;\r\n            modalshowHandler(contextid, params, true);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Clean the url parameters.\r\n     * @param {string} url page url.\r\n     * @param {string} parameter url parameter.\r\n     * @return {url} sort url\r\n     */\r\n    function removeURLParameter(url, parameter) {\r\n        // Prefer to use l.search if you have a location/link object.\r\n        var urlparts = url.split('?');\r\n        if (urlparts.length >= 2) {\r\n\r\n            var prefix = encodeURIComponent(parameter) + '=';\r\n            var pars = urlparts[1].split(/[&;]/g);\r\n\r\n            // Reverse iteration as may be destructive.\r\n            for (var i = pars.length; i-- > 0;) {\r\n                // Idiom for string.startsWith.\r\n                if (pars[i].lastIndexOf(prefix, 0) !== -1) {\r\n                    pars.splice(i, 1);\r\n                }\r\n            }\r\n\r\n            url = urlparts[0] + (pars.length > 0 ? '?' + pars.join('&') : \"\");\r\n            return url;\r\n        } else {\r\n            return url;\r\n        }\r\n    }\r\n\r\n\r\n    function modalshowHandler(contextid, params, contentDesigner = false) {\r\n        var newnote = String.get_string('newnote', 'local_learningtools');\r\n        $.when(newnote).done(function(localizedEditString) {\r\n            // Add class.\r\n            var ltoolnotebody = document.getElementsByTagName('body')[0];\r\n            if (!ltoolnotebody.classList.contains('learningtool-note')) {\r\n                ltoolnotebody.classList.add('learningtool-note');\r\n            }\r\n\r\n            ModalFactory.create({\r\n                title: localizedEditString + getPopoutAction(),\r\n                type: ModalFactory.types.SAVE_CANCEL,\r\n                body: getnoteaction(contextid, params),\r\n                large: true\r\n            }).then(function(modal) {\r\n\r\n                modal.show();\r\n\r\n                modal.getRoot().on(ModalEvents.hidden, function() {\r\n                    modal.destroy();\r\n                });\r\n\r\n                modal.getRoot().on(ModalEvents.save, function(e) {\r\n                    e.preventDefault();\r\n                    $(e.target).find(\"button[data-action=save]\").attr(\"disabled\", true);\r\n                    modal.getRoot().find('form').submit();\r\n                });\r\n\r\n                modal.getRoot().on('submit', 'form', e => {\r\n                    e.preventDefault();\r\n                    submitFormData(modal, contextid, params, contentDesigner);\r\n                });\r\n\r\n                document.querySelector(\"#popout-action\").addEventListener('click', function() {\r\n                    var pageurlobj = params.pageurl.split(\"&\");\r\n                    var pageurljson = JSON.stringify(pageurlobj);\r\n                    var url = M.cfg.wwwroot + \"/local/learningtools/ltool/note/pop_out.php?contextid=\" +\r\n                    params.contextid + \"&pagetype=\" + params.pagetype + \"&contextlevel=\" + params.contextlevel + \"&course=\"\r\n                    + params.course + \"&user=\" + params.user + \"&pageurl=\" + pageurljson + \"&pagetitle=\" + params.pagetitle\r\n                    + \"&heading=\" + params.heading + \"&sesskey=\" + params.sesskey;\r\n                    if (params.itemtype) {\r\n                        url += \"&itemtype=\" + params.itemtype + \"&itemid=\" + params.itemid;\r\n                    }\r\n                    modal.hide();\r\n                    window.open(url, '_blank');\r\n                });\r\n                return modal;\r\n            }).catch(notification.exception);\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Display the modal popup.\r\n     * @param {int} contextid context id\r\n     * @param {object} params notes info params\r\n     * @return {void}\r\n     */\r\n    function showModalLttool(contextid, params) {\r\n\r\n        var notesinfo = document.querySelector(\".ltnoteinfo #ltnote-action\");\r\n        if (notesinfo) {\r\n            notesinfo.addEventListener(\"click\", function() {\r\n                params.itemtype= '';\r\n                params.itemid= 0;\r\n                modalshowHandler(contextid, params);\r\n            });\r\n            // Hover color.\r\n            var notehovercolor = notesinfo.getAttribute(\"data-hovercolor\");\r\n            var notefontcolor = notesinfo.getAttribute(\"data-fontcolor\");\r\n            if (notehovercolor && notefontcolor) {\r\n                notesinfo.addEventListener(\"mouseover\", function() {\r\n                    document.querySelector('#ltnoteinfo p').style.background = notehovercolor;\r\n                    document.querySelector('#ltnoteinfo p').style.color = notefontcolor;\r\n                });\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sort the notes list.\r\n     * @param {string} sorttype sort type\r\n     * @return {void}\r\n     */\r\n    function noteSortActionPage(sorttype) {\r\n\r\n        var pageurl = window.location.href;\r\n        pageurl = removeURLParameter(pageurl, 'sorttype');\r\n\r\n        if (sorttype == 'asc') {\r\n            sorttype = 'desc';\r\n        } else if (sorttype == 'desc') {\r\n            sorttype = 'asc';\r\n        }\r\n        var para = '';\r\n        if (pageurl.indexOf('?') > -1) {\r\n            para = '&';\r\n        } else {\r\n            para = '?';\r\n        }\r\n\r\n        pageurl = pageurl + para + 'sorttype=' + sorttype;\r\n        window.open(pageurl, '_self');\r\n    }\r\n\r\n    /**\r\n     * Popout url action html.\r\n     * @return {string} popout html\r\n     */\r\n    function getPopoutAction() {\r\n        var popouthtml = \"<div class='popout-block'><button type='submit' id='popout-action'\"\r\n        + \"name='popoutsubmit'>Pop out</button> <i class='fa fa-window-restore'></i></div>\";\r\n        return popouthtml;\r\n    }\r\n\r\n    /**\r\n     * Submit the modal data form.\r\n     * @param {object} modal object\r\n     * @param {int} contextid context id\r\n     * @return {void} ajax respoltoolsnse.\r\n     */\r\n    function submitFormData(modal, contextid, params, contentDesigner = false) {\r\n        var modalform = document.querySelectorAll('.ltoolusernotes form')[0];\r\n        var formData = new URLSearchParams(new FormData(modalform)).toString();\r\n        var notesuccess = String.get_string('successnotemessage', 'local_learningtools');\r\n        Ajax.call([{\r\n            methodname: 'ltool_note_save_usernote',\r\n            args: {contextid: contextid, formdata: formData},\r\n            done: function(response) {\r\n                // Insert data into notes badge.\r\n                if (response) {\r\n                    // Check if this is a content designer note by looking for the trigger button\r\n                    if (contentDesigner) {\r\n                        // Try to refresh the chapter if content designer is available\r\n                        require(['mod_contentdesigner/elements'], function(Elements) {\r\n                            var chapterId = params.itemid;\r\n                            if (chapterId) {\r\n                                Elements.removeWarning();\r\n                                Elements.refreshContent();\r\n                            }\r\n                        });\r\n                    } else {\r\n                        var noteinfo = document.querySelector(\".ltnoteinfo span\");\r\n                        if (!noteinfo.classList.contains('ticked')) {\r\n                            noteinfo.classList.add('ticked');\r\n                        }\r\n                        noteinfo.innerHTML = response;\r\n                    }\r\n                }\r\n\r\n                modal.hide();\r\n                $.when(notesuccess).done(function(localizedEditString) {\r\n                    notification.addNotification({\r\n                        message: localizedEditString,\r\n                        type: \"success\"\r\n                    });\r\n                });\r\n\r\n                if (ltools.disappertimenotify != 0) {\r\n                    setTimeout(function() {\r\n                        document.querySelector(\"span.notifications\").innerHTML = \"\";\r\n                    }, ltools.disappertimenotify);\r\n                }\r\n            },\r\n        }]);\r\n    }\r\n\r\n    /**\r\n     * Submit the modal data form.\r\n     * @param {int} contextid\r\n     * @param {object} params list of the notes params.\r\n     * @return {string} displayed the note editor form\r\n     */\r\n    function getnoteaction(contextid, params) {\r\n        params.contextid = contextid;\r\n        if (params.pagetitle == \"\") {\r\n            params.pagetitle = document.querySelector(\"title\").innerHTML;\r\n        }\r\n        return Fragment.loadFragment('ltool_note', 'get_note_form', contextid, params);\r\n    }\r\n    return {\r\n        init: function(contextid, params) {\r\n            learningToolNoteAction(contextid, params);\r\n        }\r\n    };\r\n});"],"names":["define","$","ModalFactory","String","Fragment","ModalEvents","Ajax","notification","learningToolNoteAction","contextid","params","notesinfo","document","querySelector","addEventListener","itemtype","itemid","modalshowHandler","notehovercolor","getAttribute","notefontcolor","style","background","color","showModalLttool","sorttypefilter","sorttype","pageurl","window","location","href","url","parameter","urlparts","split","length","prefix","encodeURIComponent","pars","i","lastIndexOf","splice","join","removeURLParameter","para","indexOf","open","noteSortActionPage","this","on","e","button","itemType","data","itemId","contentDesigner","newnote","get_string","when","done","localizedEditString","ltoolnotebody","getElementsByTagName","classList","contains","add","create","title","getPopoutAction","type","types","SAVE_CANCEL","body","getnoteaction","large","then","modal","show","getRoot","hidden","destroy","save","preventDefault","target","find","attr","submit","submitFormData","pageurlobj","pageurljson","JSON","stringify","M","cfg","wwwroot","pagetype","contextlevel","course","user","pagetitle","heading","sesskey","hide","catch","exception","modalform","querySelectorAll","formData","URLSearchParams","FormData","toString","notesuccess","call","methodname","args","formdata","response","require","Elements","removeWarning","refreshContent","noteinfo","innerHTML","addNotification","message","ltools","disappertimenotify","setTimeout","loadFragment","init"],"mappings":";;;;;;;AAuBAA,iCAAO,CAAC,SAAU,qBAAsB,WAAY,gBAAiB,oBAAqB,YAAa,sBACnG,SAASC,EAAGC,aAAcC,OAAQC,SAAUC,YAAaC,KAAMC,uBAStDC,uBAAuBC,UAAWC,kBA6GlBD,UAAWC,YAE5BC,UAAYC,SAASC,cAAc,iCACnCF,UAAW,CACXA,UAAUG,iBAAiB,SAAS,WAChCJ,OAAOK,SAAU,GACjBL,OAAOM,OAAQ,EACfC,iBAAiBR,UAAWC,eAG5BQ,eAAiBP,UAAUQ,aAAa,mBACxCC,cAAgBT,UAAUQ,aAAa,kBACvCD,gBAAkBE,eAClBT,UAAUG,iBAAiB,aAAa,WACpCF,SAASC,cAAc,iBAAiBQ,MAAMC,WAAaJ,eAC3DN,SAASC,cAAc,iBAAiBQ,MAAME,MAAQH,kBA3HlEI,CAAgBf,UAAWC,YACvBe,eAAiBb,SAASC,cAAc,sCACxCY,gBACAA,eAAeX,iBAAiB,SAAS,qBAmIrBY,cAEpBC,QAAUC,OAAOC,SAASC,KAC9BH,iBA9GwBI,IAAKC,eAEzBC,SAAWF,IAAIG,MAAM,QACrBD,SAASE,QAAU,EAAG,SAElBC,OAASC,mBAAmBL,WAAa,IACzCM,KAAOL,SAAS,GAAGC,MAAM,SAGpBK,EAAID,KAAKH,OAAQI,KAAM,IAEY,IAApCD,KAAKC,GAAGC,YAAYJ,OAAQ,IAC5BE,KAAKG,OAAOF,EAAG,UAIvBR,IAAME,SAAS,IAAMK,KAAKH,OAAS,EAAI,IAAMG,KAAKI,KAAK,KAAO,WAGvDX,IA2FDY,CAAmBhB,QAAS,YAEtB,OAAZD,SACAA,SAAW,OACQ,QAAZA,WACPA,SAAW,WAEXkB,KAAO,GAEPA,KADAjB,QAAQkB,QAAQ,MAAQ,EACjB,IAEA,IAGXlB,QAAUA,QAAUiB,KAAO,YAAclB,SACzCE,OAAOkB,KAAKnB,QAAS,SAnJboB,CADeC,KAAK7B,aAAa,iBAKzClB,EAAEW,UAAUqC,GAAG,QAAS,uCAAuC,SAASC,OAChEC,OAASlD,EAAE+C,MACXI,SAAWD,OAAOE,KAAK,YACvBC,OAASH,OAAOE,KAAK,UACrB1B,QAAUwB,OAAOE,KAAK,WAC1B3C,OAAOK,SAAWqC,SAClB1C,OAAOM,OAASsC,OAChB5C,OAAOiB,QAAUA,QACjBV,iBAAiBR,UAAWC,QAAQ,eAkCnCO,iBAAiBR,UAAWC,YAAQ6C,4EACrCC,QAAUrD,OAAOsD,WAAW,UAAW,uBAC3CxD,EAAEyD,KAAKF,SAASG,MAAK,SAASC,yBAEtBC,cAAgBjD,SAASkD,qBAAqB,QAAQ,GACrDD,cAAcE,UAAUC,SAAS,sBAClCH,cAAcE,UAAUE,IAAI,qBAGhC/D,aAAagE,OAAO,CAChBC,MAAOP,oBAAsBQ,kBAC7BC,KAAMnE,aAAaoE,MAAMC,YACzBC,KAAMC,cAAchE,UAAWC,QAC/BgE,OAAO,IACRC,MAAK,SAASC,cAEbA,MAAMC,OAEND,MAAME,UAAU7B,GAAG5C,YAAY0E,QAAQ,WACnCH,MAAMI,aAGVJ,MAAME,UAAU7B,GAAG5C,YAAY4E,MAAM,SAAS/B,GAC1CA,EAAEgC,iBACFjF,EAAEiD,EAAEiC,QAAQC,KAAK,4BAA4BC,KAAK,YAAY,GAC9DT,MAAME,UAAUM,KAAK,QAAQE,YAGjCV,MAAME,UAAU7B,GAAG,SAAU,QAAQC,IACjCA,EAAEgC,iBACFK,eAAeX,MAAOnE,UAAWC,OAAQ6C,oBAG7C3C,SAASC,cAAc,kBAAkBC,iBAAiB,SAAS,eAC3D0E,WAAa9E,OAAOiB,QAAQO,MAAM,KAClCuD,YAAcC,KAAKC,UAAUH,YAC7BzD,IAAM6D,EAAEC,IAAIC,QAAU,yDAC1BpF,OAAOD,UAAY,aAAeC,OAAOqF,SAAW,iBAAmBrF,OAAOsF,aAAe,WAC3FtF,OAAOuF,OAAS,SAAWvF,OAAOwF,KAAO,YAAcT,YAAc,cAAgB/E,OAAOyF,UAC5F,YAAczF,OAAO0F,QAAU,YAAc1F,OAAO2F,QAClD3F,OAAOK,WACPgB,KAAO,aAAerB,OAAOK,SAAW,WAAaL,OAAOM,QAEhE4D,MAAM0B,OACN1E,OAAOkB,KAAKf,IAAK,aAEd6C,SACR2B,MAAMhG,aAAaiG,uBA6DrBpC,wBACY,6JAWZmB,eAAeX,MAAOnE,UAAWC,YAAQ6C,4EAC1CkD,UAAY7F,SAAS8F,iBAAiB,wBAAwB,GAC9DC,SAAW,IAAIC,gBAAgB,IAAIC,SAASJ,YAAYK,WACxDC,YAAc5G,OAAOsD,WAAW,qBAAsB,uBAC1DnD,KAAK0G,KAAK,CAAC,CACPC,WAAY,2BACZC,KAAM,CAACzG,UAAWA,UAAW0G,SAAUR,UACvChD,KAAM,SAASyD,aAEPA,YAEI7D,gBAEA8D,QAAQ,CAAC,iCAAiC,SAASC,UAC/B5G,OAAOM,SAEnBsG,SAASC,gBACTD,SAASE,yBAGd,KACCC,SAAW7G,SAASC,cAAc,oBACjC4G,SAAS1D,UAAUC,SAAS,WAC7ByD,SAAS1D,UAAUE,IAAI,UAE3BwD,SAASC,UAAYN,SAI7BxC,MAAM0B,OACNrG,EAAEyD,KAAKqD,aAAapD,MAAK,SAASC,qBAC9BrD,aAAaoH,gBAAgB,CACzBC,QAAShE,oBACTS,KAAM,eAImB,GAA7BwD,OAAOC,oBACPC,YAAW,WACPnH,SAASC,cAAc,sBAAsB6G,UAAY,KAC1DG,OAAOC,iCAYjBrD,cAAchE,UAAWC,eAC9BA,OAAOD,UAAYA,UACK,IAApBC,OAAOyF,YACPzF,OAAOyF,UAAYvF,SAASC,cAAc,SAAS6G,WAEhDtH,SAAS4H,aAAa,aAAc,gBAAiBvH,UAAWC,cAEpE,CACHuH,KAAM,SAASxH,UAAWC,QACtBF,uBAAuBC,UAAWC"}